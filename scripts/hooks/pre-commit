#!/bin/bash

# Memory Management Pre-Commit Hook
# BLOCKS commits if CLAUDE.md exceeds threshold
# This ensures working memory stays lean for efficient context loading

CLAUDE_MD="CLAUDE.md"
LINE_THRESHOLD=300

if [ -f "$CLAUDE_MD" ]; then
    LINE_COUNT=$(wc -l < "$CLAUDE_MD" | tr -d ' ')

    if [ "$LINE_COUNT" -gt "$LINE_THRESHOLD" ]; then
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ðŸ›‘ COMMIT BLOCKED: CLAUDE.md EXCEEDS THRESHOLD                  â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘  CLAUDE.md has $LINE_COUNT lines (max: $LINE_THRESHOLD)                          â•‘"
        echo "â•‘                                                                    â•‘"
        echo "â•‘  REQUIRED ACTION:                                                  â•‘"
        echo "â•‘  1. Prune detailed findings to docs/archive/                       â•‘"
        echo "â•‘  2. Keep only essential info in CLAUDE.md                          â•‘"
        echo "â•‘  3. Update archive index                                           â•‘"
        echo "â•‘  4. Retry commit                                                   â•‘"
        echo "â•‘                                                                    â•‘"
        echo "â•‘  Goal: Keep working memory < $LINE_THRESHOLD lines                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "To bypass (emergency only): git commit --no-verify"
        echo ""
        exit 1
    fi
fi

exit 0
